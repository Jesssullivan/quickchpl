# GitLab CI/CD Configuration for quickchpl
# Property-Based Testing Framework for Chapel

image: chapel/chapel:2.6.0

stages:
  - build
  - lint
  - test
  - docs
  - publish

variables:
  QUICKCHPL_NUM_TESTS: "100"
  QUICKCHPL_VERBOSE: "false"

# Cache Mason dependencies
cache:
  key: mason-cache
  paths:
    - ~/.mason

# ============================================
# Build Stage
# ============================================

build:
  stage: build
  script:
    - chpl --version
    # Verify all modules compile together
    - chpl -M src -M src/quickchpl --no-codegen src/quickchpl.chpl
    - echo "✓ All modules compile successfully"

# ============================================
# Lint Stage
# ============================================

lint:chplcheck:
  stage: lint
  script:
    - echo "Running chplcheck linter..."
    - chplcheck --version || echo "chplcheck version unknown"
    - chplcheck src/*.chpl src/quickchpl/*.chpl test/*.chpl test/**/*.chpl examples/*.chpl > chplcheck.log 2>&1 || true
    - cat chplcheck.log
    - |
      # Count violations (excluding intentional API design decisions)
      VIOLATIONS=$(grep -c "violates rule" chplcheck.log || true)
      echo ""
      echo "=== chplcheck Summary ==="
      echo "Total violations: $VIOLATIONS"
      echo ""

      # Known acceptable violations:
      # - 6 CamelCaseRecords (generator types - intentional API)
      # - 1 PascalCaseModules (quickchpl - package name)
      ACCEPTABLE=7

      if [ "$VIOLATIONS" -gt "$ACCEPTABLE" ]; then
        echo "❌ Too many chplcheck violations (expected <=$ACCEPTABLE, got $VIOLATIONS)"
        exit 1
      else
        echo "✅ chplcheck passed (acceptable violations: $VIOLATIONS/$ACCEPTABLE)"
      fi
  artifacts:
    paths:
      - chplcheck.log
    expire_in: 1 week
    when: always

lint:whitespace:
  stage: lint
  script:
    - echo "Checking for trailing whitespace..."
    - |
      ! grep -rn '[[:space:]]$' src/*.chpl src/quickchpl/*.chpl test/*.chpl test/**/*.chpl examples/*.chpl || {
        echo "Found trailing whitespace"
        exit 1
      }

lint:permissions:
  stage: lint
  script:
    - echo "Checking execute permissions on source files..."
    - |
      find src test examples -name "*.chpl" -perm +111 && {
        echo "Found executable .chpl files (should not be executable)"
        exit 1
      } || echo "✓ No executable .chpl files found"

# ============================================
# Test Stage
# ============================================

test:unit:generators:
  stage: test
  script:
    - echo "Running Generator Tests..."
    - chpl -M src -M src/quickchpl test/unit/GeneratorTests.chpl -o /tmp/generator_tests
    - /tmp/generator_tests

test:unit:shrinkers:
  stage: test
  script:
    - echo "Running Shrinker Tests..."
    - chpl -M src -M src/quickchpl test/unit/ShrinkerTests.chpl -o /tmp/shrinker_tests
    - /tmp/shrinker_tests

test:unit:properties:
  stage: test
  script:
    - echo "Running Property Tests..."
    - chpl -M src -M src/quickchpl test/unit/PropertyTests.chpl -o /tmp/property_tests
    - /tmp/property_tests

test:examples:
  stage: test
  script:
    - echo "Running Getting Started Example..."
    - chpl -M src -M src/quickchpl examples/GettingStarted.chpl -o /tmp/getting_started
    - /tmp/getting_started
    - echo "Running Algebraic Properties Example..."
    - chpl -M src -M src/quickchpl examples/AlgebraicProperties.chpl -o /tmp/algebraic
    - /tmp/algebraic
    - echo "Running Custom Generators Example..."
    - chpl -M src -M src/quickchpl examples/CustomGenerators.chpl -o /tmp/custom_gen
    - /tmp/custom_gen

test:self:
  stage: test
  script:
    - echo "Running quickchpl self-tests..."
    - chpl -M src -M src/quickchpl test/properties/SelfTests.chpl -o /tmp/self_tests
    - /tmp/self_tests --numTests=$QUICKCHPL_NUM_TESTS

# Matrix testing for Chapel versions
.test:matrix:
  stage: test
  script:
    - chpl --version
    - chpl -M src -M src/quickchpl test/unit/GeneratorTests.chpl -o /tmp/test
    - /tmp/test

test:chapel-2.6.0:
  extends: .test:matrix
  image: chapel/chapel:2.6.0

test:chapel-2.7.0:
  extends: .test:matrix
  image: chapel/chapel:2.7.0

# ============================================
# Documentation Stage
# ============================================

docs:chpldoc:
  stage: docs
  script:
    - mkdir -p docs/api
    - |
      for file in src/quickchpl.chpl src/quickchpl/*.chpl; do
        echo "Generating docs for $file...";
        chpldoc "$file" --output-dir docs/api || echo "Warning: chpldoc failed for $file";
      done
  artifacts:
    paths:
      - docs/api/
    expire_in: 1 week

# ============================================
# GitLab Pages - Documentation Hosting
# ============================================

pages:
  stage: publish
  needs: ["docs:chpldoc"]
  script:
    - mkdir -p public
    - cp -r docs/api/* public/ || echo "No API docs to copy"
    - |
      cat > public/index.html << 'HTMLEOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>quickchpl API Documentation</title>
        <style>
          :root { --bg: #1a1a2e; --fg: #eee; --accent: #7b68ee; --code-bg: #16213e; }
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                 background: var(--bg); color: var(--fg); line-height: 1.6; padding: 2rem; }
          .container { max-width: 960px; margin: 0 auto; }
          h1 { color: var(--accent); margin-bottom: 1rem; font-size: 2.5rem; }
          h2 { color: var(--accent); margin-top: 2rem; margin-bottom: 0.5rem; }
          p { margin-bottom: 1rem; }
          a { color: var(--accent); text-decoration: none; }
          a:hover { text-decoration: underline; }
          .badge { display: inline-block; background: var(--accent); color: white;
                   padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin: 0.25rem; }
          code { background: var(--code-bg); padding: 0.125rem 0.25rem; border-radius: 2px; }
          pre { background: var(--code-bg); padding: 1rem; border-radius: 4px;
                overflow-x: auto; margin: 1rem 0; }
          .modules { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                     gap: 1rem; margin: 2rem 0; }
          .module { background: var(--code-bg); padding: 1rem; border-radius: 8px;
                    border: 1px solid var(--accent); }
          .module h3 { color: var(--accent); margin-bottom: 0.5rem; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>quickchpl</h1>
          <p>Property-Based Testing Framework for Chapel</p>
          <div>
            <span class="badge">Chapel 2.6+</span>
            <span class="badge">MIT License</span>
            <span class="badge">v1.0.0</span>
          </div>

          <h2>Modules</h2>
          <div class="modules">
            <div class="module">
              <h3>Generators</h3>
              <p>Random value generators for testing</p>
              <a href="Generators.html">Documentation</a>
            </div>
            <div class="module">
              <h3>Properties</h3>
              <p>Property definition and execution</p>
              <a href="Properties.html">Documentation</a>
            </div>
            <div class="module">
              <h3>Shrinkers</h3>
              <p>Counterexample minimization</p>
              <a href="Shrinkers.html">Documentation</a>
            </div>
            <div class="module">
              <h3>Reporters</h3>
              <p>Test result formatting</p>
              <a href="Reporters.html">Documentation</a>
            </div>
            <div class="module">
              <h3>Combinators</h3>
              <p>Generator composition utilities</p>
              <a href="Combinators.html">Documentation</a>
            </div>
            <div class="module">
              <h3>Patterns</h3>
              <p>Common property patterns</p>
              <a href="Patterns.html">Documentation</a>
            </div>
          </div>

          <h2>Quick Start</h2>
          <pre><code>use quickchpl;

// Define a property
var prop = property("addition commutes",
                    tupleGen(intGen(), intGen()),
                    lambda((a, b): (int, int)) { return a + b == b + a; });

// Check the property
var result = check(prop);
assert(result.passed);</code></pre>

          <h2>Links</h2>
          <p>
            <a href="https://github.com/Jesssullivan/quickchpl">GitHub Repository</a> |
            <a href="https://github.com/Jesssullivan/quickchpl/tree/main/examples">Examples</a> |
            <a href="https://github.com/Jesssullivan/quickchpl/blob/main/README.md">README</a>
          </p>
        </div>
      </body>
      </html>
      HTMLEOF
  artifacts:
    paths:
      - public
  only:
    - main
