# GitLab CI/CD Configuration for quickchpl
# Property-Based Testing Framework for Chapel

image: chapel/chapel:2.6.0

stages:
  - build
  - lint
  - test
  - docs
  - publish

variables:
  QUICKCHPL_NUM_TESTS: "100"
  QUICKCHPL_VERBOSE: "false"

# Cache Mason dependencies
cache:
  key: mason-cache
  paths:
    - ~/.mason

# ============================================
# Build Stage
# ============================================

build:
  stage: build
  script:
    - chpl --version
    # Verify all modules compile together
    - chpl -M src -M src/quickchpl --no-codegen src/quickchpl.chpl
    - echo "✓ All modules compile successfully"

# ============================================
# Lint Stage
# ============================================

lint:chplcheck:
  stage: lint
  script:
    - echo "Running chplcheck linter..."
    - chplcheck --version || echo "chplcheck version unknown"
    - chplcheck src/*.chpl src/quickchpl/*.chpl test/*.chpl test/**/*.chpl examples/*.chpl > chplcheck.log 2>&1 || true
    - cat chplcheck.log
    - |
      # Count violations (excluding intentional API design decisions)
      VIOLATIONS=$(grep -c "violates rule" chplcheck.log || true)
      echo ""
      echo "=== chplcheck Summary ==="
      echo "Total violations: $VIOLATIONS"
      echo ""

      # Known acceptable violations:
      # - 6 CamelCaseRecords (generator types - intentional API)
      # - 1 PascalCaseModules (quickchpl - package name)
      ACCEPTABLE=7

      if [ "$VIOLATIONS" -gt "$ACCEPTABLE" ]; then
        echo "❌ Too many chplcheck violations (expected <=$ACCEPTABLE, got $VIOLATIONS)"
        exit 1
      else
        echo "✅ chplcheck passed (acceptable violations: $VIOLATIONS/$ACCEPTABLE)"
      fi
  artifacts:
    paths:
      - chplcheck.log
    expire_in: 1 week
    when: always

lint:whitespace:
  stage: lint
  script:
    - echo "Checking for trailing whitespace..."
    - |
      ! grep -rn '[[:space:]]$' src/*.chpl src/quickchpl/*.chpl test/*.chpl test/**/*.chpl examples/*.chpl || {
        echo "Found trailing whitespace"
        exit 1
      }

lint:permissions:
  stage: lint
  script:
    - echo "Checking execute permissions on source files..."
    - |
      find src test examples -name "*.chpl" -perm +111 && {
        echo "Found executable .chpl files (should not be executable)"
        exit 1
      } || echo "✓ No executable .chpl files found"

# ============================================
# Test Stage
# ============================================

test:unit:generators:
  stage: test
  script:
    - echo "Running Generator Tests..."
    - chpl -M src -M src/quickchpl test/unit/GeneratorTests.chpl -o /tmp/generator_tests
    - /tmp/generator_tests

test:unit:shrinkers:
  stage: test
  script:
    - echo "Running Shrinker Tests..."
    - chpl -M src -M src/quickchpl test/unit/ShrinkerTests.chpl -o /tmp/shrinker_tests
    - /tmp/shrinker_tests

test:unit:properties:
  stage: test
  script:
    - echo "Running Property Tests..."
    - chpl -M src -M src/quickchpl test/unit/PropertyTests.chpl -o /tmp/property_tests
    - /tmp/property_tests

test:examples:
  stage: test
  script:
    - echo "Running Getting Started Example..."
    - chpl -M src -M src/quickchpl examples/GettingStarted.chpl -o /tmp/getting_started
    - /tmp/getting_started
    - echo "Running Algebraic Properties Example..."
    - chpl -M src -M src/quickchpl examples/AlgebraicProperties.chpl -o /tmp/algebraic
    - /tmp/algebraic
    - echo "Running Custom Generators Example..."
    - chpl -M src -M src/quickchpl examples/CustomGenerators.chpl -o /tmp/custom_gen
    - /tmp/custom_gen

test:self:
  stage: test
  script:
    - echo "Running quickchpl self-tests..."
    - chpl -M src -M src/quickchpl test/properties/SelfTests.chpl -o /tmp/self_tests
    - /tmp/self_tests --numTests=$QUICKCHPL_NUM_TESTS

# Matrix testing for Chapel versions
.test:matrix:
  stage: test
  script:
    - chpl --version
    - chpl -M src -M src/quickchpl test/unit/GeneratorTests.chpl -o /tmp/test
    - /tmp/test

test:chapel-2.6.0:
  extends: .test:matrix
  image: chapel/chapel:2.6.0

test:chapel-2.7.0:
  extends: .test:matrix
  image: chapel/chapel:2.7.0

# ============================================
# Documentation Stage
# ============================================

docs:chpldoc:
  stage: docs
  script:
    - mkdir -p docs/api
    - |
      for file in src/quickchpl.chpl src/quickchpl/*.chpl; do
        echo "Generating docs for $file...";
        chpldoc "$file" --output-dir docs/api || echo "Warning: chpldoc failed for $file";
      done
  artifacts:
    paths:
      - docs/api/
    expire_in: 1 week

docs:mkdocs:
  stage: docs
  image: python:3.13-slim
  script:
    - pip install -r docs/requirements.txt
    - mkdocs build --strict --verbose
    - test -f site/llms.txt || echo "Warning: llms.txt not generated"
    - test -f site/llms-full.txt || echo "Warning: llms-full.txt not generated"
  artifacts:
    paths:
      - site/
    expire_in: 1 week

docs:linkcheck:
  stage: docs
  image: python:3.13-slim
  needs: ["docs:mkdocs"]
  script:
    - pip install linkchecker
    - linkchecker site/index.html --check-extern || true
  allow_failure: true

# ============================================
# GitLab Pages - Documentation Hosting
# ============================================

pages:
  stage: publish
  needs: ["docs:mkdocs"]
  script:
    - mkdir -p public
    - cp -r site/* public/
  artifacts:
    paths:
      - public
  only:
    - main
